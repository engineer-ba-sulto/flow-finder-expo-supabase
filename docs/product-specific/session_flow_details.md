# 点検セッション詳細フロー

## 概要

ユーザーは週次／月次で **5 ステップのウィザード** を実行し、ボトルネックを特定して "小さな一歩" を決定します。各ステップは **React Native スクリーン** として実装し、AsyncStorage または Supabase による自動保存で中断しても途中から再開できる設計とします。

## 🎯 共通 UI 要素

- **進捗バー**：現在のステップ / 全 5 ステップ
- **自動保存**：フォーム入力内容を自動で Supabase に保存
- **ヘルプモーダル**：各ステップ右上の "?" からフレームワーク解説を表示
- **モバイル最適化**：スワイプジェスチャーでステップ間移動

## 📋 各ステップの詳細

### Step 1. 現状の特定

**質問**: "今、最も進んでいないことは何ですか？"

| 項目             | 実装詳細                                                        |
| ---------------- | --------------------------------------------------------------- |
| 入力 UI          | `TextInput`（React Native） + 80 文字カウンタ                   |
| プレースホルダー | 例：「資格試験の勉強」「副業ブログ記事作成」                    |
| ゴール紐付け     | Picker/Modal で既存ゴールを表示 + "＋新規ゴール" でモーダル作成 |
| バリデーション   | 1〜200 文字必須。RHF + Zod                                      |

**UI モックアップ**：

```
┌─────────────────────────────────────┐
│ 📊 Step 1/5                        │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│ ████████░░░░░░░░░░░░░░░░░░░░░░░░░░░░░ │
│                                     │
│ 今、最も進んでいないことは何ですか？ │
│                                     │
│ 📝 関連するゴール:                  │
│ ┌─────────────────────────────────┐ │
│ │ 英語学習マスター            ▼ │ │
│ └─────────────────────────────────┘ │
│ または ＋新規ゴールを作成            │
│                                     │
│ 💭 どんなことでも構いません:        │
│ ┌─────────────────────────────────┐ │
│ │ 資格試験の勉強が全然進まない... │ │
│ │                               │ │
│ │                               │ │
│ └─────────────────────────────────┘ │
│ 残り文字数: 167/200                 │
│                                     │
│ [戻る]                     [次へ] │
└─────────────────────────────────────┘
```

### Step 2. 原因の深掘り

**質問**: "なぜ、それが進んでいないのでしょうか？"

**実装詳細**：

- **ヒントチップ**：感情的（モチベーション／恐れ）・環境的（時間／場所）・スキル的（知識不足）などをアイコン付きで提示
- 300 文字上限で自由入力
- スキマが分からない場合は **"AI ヒント"** ボタンで OpenAI API を利用（Premium のみ）

**UI モックアップ**：

```
┌─────────────────────────────────────┐
│ 📊 Step 2/5                        │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│ ████████████████░░░░░░░░░░░░░░░░░░░░░ │
│                                     │
│ なぜ、それが進んでいないのでしょう？ │
│                                     │
│ 💡 よくある原因のヒント:            │
│ ┌─────────────────────────────────┐ │
│ │ 📅 時間  🏠 環境  💪 スキル    │ │
│ │ 😟 感情  👥 サポート  🎯 目標  │ │
│ └─────────────────────────────────┘ │
│                                     │
│ 💭 思い当たることを書いてください:  │
│ ┌─────────────────────────────────┐ │
│ │ 仕事が忙しくて時間がない。      │ │
│ │ 帰宅後は疲れてしまって集中でき  │ │
│ │ ない。勉強する場所も決まってな  │ │
│ │ い。                            │ │
│ └─────────────────────────────────┘ │
│ 残り文字数: 256/300                 │
│                                     │
│ 🤖 AI ヒント (Premium)              │
│ [戻る]                     [次へ] │
└─────────────────────────────────────┘
```

### Step 3. 制約の検証

**質問**: "その理由は本当のボトルネックですか？"

| コンポーネント | 説明                                                                     |
| -------------- | ------------------------------------------------------------------------ |
| ToggleButton   | Yes / No を選択。選択時にハプティックフィードバック                      |
| No 選択時      | Alert「素晴らしい気づき！別の課題を再選択しましょう」→ Step 1 に自動遷移 |
| Yes 選択時     | `Continue` ボタン活性化                                                  |

**UI モックアップ**：

```
┌─────────────────────────────────────┐
│ 📊 Step 3/5                        │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│ ████████████████████████░░░░░░░░░░░░░ │
│                                     │
│ その理由は本当のボトルネックですか？ │
│                                     │
│ 💭 あなたの回答:                    │
│ 「仕事が忙しくて時間がない。        │
│  帰宅後は疲れてしまって集中でき     │
│  ない。勉強する場所も決まってない」 │
│                                     │
│ 🤔 少し立ち止まって考えてみましょう │
│                                     │
│ この理由は本当の原因でしょうか？    │
│ それとも、他に隠れた要因がありそう  │
│ でしょうか？                        │
│                                     │
│ ┌─────────────────────────────────┐ │
│ │  ✅ はい、これが本当の原因です  │ │
│ └─────────────────────────────────┘ │
│ ┌─────────────────────────────────┐ │
│ │  🔄 いいえ、他にありそうです   │ │
│ └─────────────────────────────────┘ │
│                                     │
│ [戻る]                     [次へ] │
└─────────────────────────────────────┘
```

### Step 4. 小さな一歩の決定

**質問**: "解消するためにできる"小さな一歩"は何ですか？"

**実装詳細**：

- 具体アクション入力 + 所要時間（5,10,30 分の Segmented Control）
- **"提案を生成"** ボタンで OpenAI API → 3 個の小さな一歩候補をタップ可能なカードで表示（Premium のみ）
- 決定後、`Action` テーブルへ INSERT、`アクションリスト` に即時反映

**無料プランでの表示**：

```
┌─────────────────────────────────────┐
│ 📊 Step 4/5                        │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│ ████████████████████████████████░░░░░ │
│                                     │
│ 解消するための「小さな一歩」は？    │
│                                     │
│ 🎯 あなたの状況に最適なヒント:      │
│ ├ 📅 時間管理 (最適)                │
│ │  └ ✨ 朝の15分だけ取り組む        │
│ │  └ ✨ 通勤時間を活用する          │
│ │  └ ✨ 昼休みの5分だけ勉強する     │
│ │                                  │
│ └ 📋 その他のヒント:                │
│   ├ 🏠 環境設定                    │
│   │  └ 勉強専用の場所を作る         │
│   └ 🎯 モチベーション              │
│     └ 小さなご褒美を設定する        │
│                                     │
│ 💭 あなたの小さな一歩:              │
│ ┌─────────────────────────────────┐ │
│ │ 朝の通勤時間15分だけ英語アプリ  │ │
│ │ を開く                          │ │
│ └─────────────────────────────────┘ │
│                                     │
│ ⏰ 所要時間: [5分] [15分] [30分]   │
│                                     │
│ 🔒 AI提案機能 (Premium限定)         │
│ [戻る]                     [次へ] │
└─────────────────────────────────────┘
```

**Premium プランでの表示**：

```
┌─────────────────────────────────────┐
│ 📊 Step 4/5                        │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│ ████████████████████████████████░░░░░ │
│                                     │
│ 解消するための「小さな一歩」は？    │
│                                     │
│ 🤖 AI からの個別提案:               │
│ ┌─────────────────────────────────┐ │
│ │ 1. 朝の通勤時間（電車15分）に    │ │
│ │    英語ポッドキャストを聞く      │ │
│ │    → 毎日実行しやすい           │ │
│ │                                 │ │
│ │ 2. 昼休憩の最初の10分で          │ │
│ │    英単語アプリを5問だけ解く     │ │
│ │    → 負担が少なく継続可能       │ │
│ │                                 │ │
│ │ 3. 寝る前の5分だけ               │ │
│ │    英語の短文を1つ読む          │ │
│ │    → 習慣化しやすいタイミング   │ │
│ └─────────────────────────────────┘ │
│                                     │
│ 💭 または自分で入力:                │
│ ┌─────────────────────────────────┐ │
│ │ 朝の通勤時間15分だけ英語アプリ  │ │
│ │ を開く                          │ │
│ └─────────────────────────────────┘ │
│                                     │
│ ⏰ 所要時間: [5分] [15分] [30分]   │
│ [戻る]                     [次へ] │
└─────────────────────────────────────┘
```

### Step 5. 次のボトルネック予測

**質問**: "次にボトルネックになりそうなポイントはどこですか？"

**実装詳細**：

- フリーテキスト + タグ選択（例：時間管理、インプット不足）
- 完了時に **セッションまとめ** モーダルを表示：
  - ボトルネック要約
  - 小さな一歩
  - 次の予測
  - SNS 共有ボタン

**UI モックアップ**：

```
┌─────────────────────────────────────┐
│ 📊 Step 5/5                        │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│ ████████████████████████████████████░ │
│                                     │
│ 次にボトルネックになりそうなポイント│
│ はどこですか？                      │
│                                     │
│ 💭 予想される課題:                  │
│ ┌─────────────────────────────────┐ │
│ │ 朝の時間は確保できそうだが、    │ │
│ │ 継続するモチベーションが続くか  │ │
│ │ 心配。また、英語アプリの内容が  │ │
│ │ 難しすぎる可能性もある。        │ │
│ └─────────────────────────────────┘ │
│                                     │
│ 🏷️ 関連タグ:                        │
│ [継続性] [モチベーション] [難易度]  │
│ [習慣化] [時間管理] [学習方法]      │
│                                     │
│ 💡 選択したタグが今後のヒント表示   │
│ に活用されます                      │
│                                     │
│ [戻る]                     [完了] │
└─────────────────────────────────────┘
```

## 🎉 セッション完了モーダル

**完了時の表示**：

```
┌─────────────────────────────────────┐
│ 🎉 点検セッション完了！             │
│                                     │
│ 📋 今回の成果:                      │
│ ┌─────────────────────────────────┐ │
│ │ 🎯 ボトルネック:                │ │
│ │ 「時間がない」                  │ │
│ │                                 │ │
│ │ 🚀 小さな一歩:                  │ │
│ │ 「朝の通勤時間15分だけ英語アプリ │ │
│ │  を開く」                       │ │
│ │                                 │ │
│ │ 🔮 次の予測:                    │ │
│ │ 「継続するモチベーション」      │ │
│ └─────────────────────────────────┘ │
│                                     │
│ ✅ アクションリストに追加されました │
│                                     │
│ 📱 SNS で共有:                      │
│ [Twitter] [Facebook] [LINE]         │
│                                     │
│ 📊 次回の点検セッション:            │
│ 2024年6月15日 (2週間後)            │
│                                     │
│ [ホームに戻る]          [履歴を見る] │
└─────────────────────────────────────┘
```

## 📱 モバイル最適化

### スワイプジェスチャー

- **右スワイプ**：前のステップに戻る
- **左スワイプ**：次のステップに進む（入力完了時のみ）
- **ピンチ**：テキストサイズ調整

### 中断・再開機能

```typescript
// 自動保存機能
const saveSessionProgress = async (step: number, data: any) => {
  await supabase.from("session_progress").upsert({
    user_id: user.id,
    step: step,
    data: data,
    updated_at: new Date().toISOString(),
  });
};

// 再開機能
const resumeSession = async () => {
  const { data } = await supabase
    .from("session_progress")
    .select("*")
    .eq("user_id", user.id)
    .order("updated_at", { ascending: false })
    .limit(1);

  if (data && data.length > 0) {
    // 中断されたステップから再開
    navigateToStep(data[0].step, data[0].data);
  }
};
```

## 🏆 ゴール完了時の振り返りセッション

ゴールが達成された際に、ユーザーの成長を確認し次のゴールにつなげるための振り返りセッションを実行します。このセッションは自動的に起動され、学習の定着と継続的な成長をサポートします。

### 振り返りフロー（3ステップ）

#### Step 1. 達成の振り返り

**質問**: "このゴールを達成して、何を学びましたか？"

```
┌─────────────────────────────────────┐
│ 🎉 ゴール達成の振り返り Step 1/3    │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│ ███████████░░░░░░░░░░░░░░░░░░░░░░░░░░░ │
│                                     │
│ 🎯 達成したゴール:                  │
│ 「英語学習マスター」                │
│ 期間: 74日間                       │
│                                     │
│ 💭 このゴールを達成して、何を学び   │
│ ましたか？                          │
│                                     │
│ 🌟 学びのヒント:                    │
│ ┌─────────────────────────────────┐ │
│ │ ・最も効果的だった取り組み方      │ │
│ │ ・思っていたより難しかった点      │ │
│ │ ・思っていたより簡単だった点      │ │
│ │ ・途中で変えた戦略や方法          │ │
│ └─────────────────────────────────┘ │
│                                     │
│ 💬 あなたの学び:                    │
│ ┌─────────────────────────────────┐ │
│ │ 朝の時間を活用することで継続    │ │
│ │ しやすいと分かった。完璧を目指  │ │
│ │ さず毎日少しずつ取り組むことが  │ │
│ │ 大切だった。                    │ │
│ └─────────────────────────────────┘ │
│ 残り文字数: 244/400                 │
│                                     │
│              [次へ]                 │
└─────────────────────────────────────┘
```

#### Step 2. 困難の克服

**質問**: "最も大変だった壁をどうやって乗り越えましたか？"

```
┌─────────────────────────────────────┐
│ 🎉 ゴール達成の振り返り Step 2/3    │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│ ██████████████████████░░░░░░░░░░░░░░░ │
│                                     │
│ 💪 最も大変だった壁をどうやって     │
│ 乗り越えましたか？                  │
│                                     │
│ 📊 あなたが解消したボトルネック:    │
│ ┌─────────────────────────────────┐ │
│ │ 1. 時間がない → 朝活の習慣化    │ │
│ │ 2. 集中できない → 場所を固定    │ │
│ │ 3. モチベ維持 → 小さな目標設定  │ │
│ │ 4. 学習方法 → アプリとポッドキャスト│ │
│ │ 5. 継続性 → 習慣トラッカー活用  │ │
│ └─────────────────────────────────┘ │
│                                     │
│ 💭 この中で最も効果的だった解決策: │
│ ┌─────────────────────────────────┐ │
│ │ 朝活の習慣化が一番大きかった。  │ │
│ │ 夜は疲れているが、朝は頭がすっ  │ │
│ │ きりしていて集中できた。15分と  │ │
│ │ 決めたことで負担感もなかった。  │ │
│ └─────────────────────────────────┘ │
│                                     │
│ [戻る]                     [次へ] │
└─────────────────────────────────────┘
```

#### Step 3. 次への活用

**質問**: "この経験を次のゴールにどう活かしますか？"

```
┌─────────────────────────────────────┐
│ 🎉 ゴール達成の振り返り Step 3/3    │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│ ████████████████████████████████████░ │
│                                     │
│ 🚀 この経験を次のゴールにどう       │
│ 活かしますか？                      │
│                                     │
│ 🎯 活かせるポイント:                │
│ ┌─────────────────────────────────┐ │
│ │ ✅ 朝の時間活用法                │ │
│ │ ✅ 小さく始める重要性            │ │
│ │ ✅ 習慣化のコツ                  │ │
│ │ ✅ ボトルネック解消のパターン    │ │
│ └─────────────────────────────────┘ │
│                                     │
│ 💭 次のゴールへの活かし方:          │
│ ┌─────────────────────────────────┐ │
│ │ 同じく朝の時間を使って新しい    │ │
│ │ 挑戦をする。今回学んだ「完璧を  │ │
│ │ 目指さない」姿勢を次でも大切に  │ │
│ │ したい。                        │ │
│ └─────────────────────────────────┘ │
│                                     │
│ 評価してください:                   │
│ 難しさ: ⭐⭐⭐⭐☆                 │
│ 満足度: ⭐⭐⭐⭐⭐                 │
│                                     │
│ [戻る]                     [完了] │
└─────────────────────────────────────┘
```

### 振り返り完了・記録保存

```typescript
// 振り返りデータの保存
const saveGoalReflection = async (goalId: string, reflectionData: {
  learnings: string;
  obstacles: string;
  solutions: string;
  nextApplication: string;
  difficultyRating: number;
  satisfactionRating: number;
}) => {
  // achievements テーブルに保存
  await supabase.from("achievements").insert({
    goal_id: goalId,
    user_id: user.id,
    total_days: calculateDays(goal.created_at, new Date()),
    bottlenecks_resolved: goal.bottlenecks?.length || 0,
    actions_completed: goal.actions?.filter(a => a.done).length || 0,
    key_learnings: reflectionData.learnings,
    difficulty_rating: reflectionData.difficultyRating,
    satisfaction_rating: reflectionData.satisfactionRating,
    reflection_data: {
      obstacles: reflectionData.obstacles,
      solutions: reflectionData.solutions,
      next_application: reflectionData.nextApplication
    }
  });
};
```

### 次のゴール提案フロー（Premium）

振り返り完了後、Premiumユーザーには AI による次のゴール提案が表示されます：

```
┌─────────────────────────────────────┐
│ 🤖 次のゴール提案                   │
│                                     │
│ あなたの振り返り内容から、以下の    │
│ ゴールを提案します：                │
│                                     │
│ 🎯 パターン分析結果:                │
│ ┌─────────────────────────────────┐ │
│ │ ✓ 朝活が得意                    │ │
│ │ ✓ 小さな習慣作りが上手          │ │
│ │ ✓ 学習系のゴールに向いている    │ │
│ └─────────────────────────────────┘ │
│                                     │
│ 💡 おすすめの次のゴール:            │
│ ┌─────────────────────────────────┐ │
│ │ 📚 プレゼンテーション力向上      │ │
│ │ 理由: 英語力を活用できる新領域  │ │
│ │                            [+] │ │
│ └─────────────────────────────────┘ │
│ ┌─────────────────────────────────┐ │
│ │ 💪 運動習慣の定着               │ │
│ │ 理由: 朝活パターンを応用可能    │ │
│ │                            [+] │ │
│ └─────────────────────────────────┘ │
│ ┌─────────────────────────────────┐ │
│ │ 📝 ブログ継続                   │ │
│ │ 理由: 学習内容をアウトプット    │ │
│ │                            [+] │ │
│ └─────────────────────────────────┘ │
│                                     │
│ [自分で作成]           [後で設定] │
└─────────────────────────────────────┘
```

## 🔄 エラーハンドリング

### 接続エラー時

```
┌─────────────────────────────────────┐
│ 🔌 接続エラー                       │
│                                     │
│ インターネット接続を確認してください│
│                                     │
│ 💾 入力内容は自動保存されています   │
│                                     │
│ [再試行]              [オフライン続行] │
└─────────────────────────────────────┘
```

### 入力エラー時

```
┌─────────────────────────────────────┐
│ ⚠️ 入力エラー                       │
│                                     │
│ 内容を1文字以上入力してください     │
│                                     │
│ [OK]                                │
└─────────────────────────────────────┘
```

---

点検セッション完了後は`History` テーブルに、振り返りセッション完了後は `Achievements` テーブルにデータを保存し、ユーザーはホーム画面にナビゲートされます。
